name: WakaTime Activity Visualization

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight UTC
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Generate WakaTime activity heatmap
        run: |
          cat > generate_wakatime_heatmap.py << 'EOF'
          import requests
          from datetime import datetime

          # Fetch WakaTime data from your JSON URL
          url = "https://wakatime.com/share/@sandeepyadav1478/a0d90c2c-04e0-4be5-8b32-3a0474042b36.json"
          print(f"Fetching WakaTime data from: {url}")

          response = requests.get(url)
          if response.status_code != 200:
              print(f"Error: {response.status_code}")
              exit(1)

          data = response.json()
          contributions = {}

          # Parse WakaTime JSON - note the structure uses "days" not "data"
          if 'days' in data:
              for day in data['days']:
                  date = day.get('date', '')
                  total = day.get('total', 0)
                  hours = total / 3600  # Convert seconds to hours

                  # Map hours to contribution level (0-4, GitHub style)
                  if hours == 0:
                      level = 0
                  elif hours < 1:
                      level = 1
                  elif hours < 3:
                      level = 2
                  elif hours < 5:
                      level = 3
                  else:
                      level = 4

                  contributions[date] = level

          print(f"âœ“ Parsed {len(contributions)} days of coding activity")

          # SVG generation settings
          cell_size = 11
          cell_gap = 3
          margin = 20
          weeks = 53
          days_per_week = 7

          width = (cell_size + cell_gap) * weeks + margin * 2
          height = (cell_size + cell_gap) * days_per_week + margin * 2 + 70

          # GitHub-style color scheme
          colors = {
              0: '#ebedf0',  # No activity
              1: '#9be9a8',  # < 1 hour
              2: '#40c463',  # 1-3 hours
              3: '#30a14e',  # 3-5 hours
              4: '#216e39',  # 5+ hours
          }

          # Start building SVG
          svg = f'''<svg width="{width}" height="{height}" xmlns="http://www.w3.org/2000/svg">
              <rect width="{width}" height="{height}" fill="#ffffff"/>

              <!-- Title -->
              <text x="{width/2}" y="25"
                    font-family="-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif"
                    font-size="16" font-weight="600" text-anchor="middle" fill="#24292f">
                  WakaTime Coding Activity (Last Year)
              </text>

              <g transform="translate({margin}, 55)">
          '''

          # Generate contribution grid
          if contributions:
              sorted_dates = sorted(contributions.keys())
              start_date = datetime.strptime(sorted_dates[0], '%Y-%m-%d')

              for date_str, level in contributions.items():
                  current_date = datetime.strptime(date_str, '%Y-%m-%d')
                  days_diff = (current_date - start_date).days

                  week = days_diff // 7
                  day = days_diff % 7

                  x = week * (cell_size + cell_gap)
                  y = day * (cell_size + cell_gap)

                  color = colors.get(level, colors[0])

                  # Add rect with title for hover
                  svg += f'    <rect x="{x}" y="{y}" width="{cell_size}" height="{cell_size}" fill="{color}" rx="2">\n'
                  svg += f'        <title>{date_str}</title>\n'
                  svg += f'    </rect>\n'

          # Add legend
          legend_y = days_per_week * (cell_size + cell_gap) + 25
          svg += f'''    </g>

              <!-- Legend -->
              <g transform="translate({width - 240}, {legend_y + 55})">
                  <text x="0" y="0" font-family="Arial,sans-serif" font-size="11" fill="#656d76">
                      Less
                  </text>
          '''

          for i in range(5):
              x = 35 + i * (cell_size + cell_gap)
              svg += f'        <rect x="{x}" y="-10" width="{cell_size}" height="{cell_size}" fill="{colors[i]}" rx="2"/>\n'

          svg += f'''        <text x="{35 + 5 * (cell_size + cell_gap) + 10}" y="0" font-family="Arial,sans-serif" font-size="11" fill="#656d76">
                      More
                  </text>
              </g>

              <!-- Stats -->
              <text x="{margin}" y="{height - 10}" font-family="Arial,sans-serif" font-size="10" fill="#656d76">
                  Total days: {len(contributions)} | Updated: {datetime.now().strftime("%Y-%m-%d")}
              </text>
          </svg>'''

          # Save SVG file
          with open('wakatime_activity_heatmap.svg', 'w') as f:
              f.write(svg)

          print(f"âœ“ Generated heatmap SVG with {len(contributions)} days")
          print("âœ“ File saved: wakatime_activity_heatmap.svg")
          EOF

          python generate_wakatime_heatmap.py

      - name: Generate GitHub contribution snake
        uses: Platane/snk@v3
        continue-on-error: true
        with:
          github_user_name: sandeepyadav1478
          outputs: |
            github-snake.svg
            github-snake-dark.svg?palette=github-dark

      - name: Prepare output directory
        run: |
          mkdir -p dist
          mv wakatime_activity_heatmap.svg dist/
          mv github-snake.svg dist/ 2>/dev/null || true
          mv github-snake-dark.svg dist/ 2>/dev/null || true

      - name: Deploy to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output success
        run: |
          echo "âœ… WakaTime visualization generated successfully!"
          echo ""
          echo "ðŸ”— View your visualizations:"
          echo "   WakaTime Heatmap: https://raw.githubusercontent.com/sandeepyadav1478/sandeepyadav1478/output/wakatime_activity_heatmap.svg"
          echo "   GitHub Snake: https://raw.githubusercontent.com/sandeepyadav1478/sandeepyadav1478/output/github-snake-dark.svg"
